<!-- app/views/shared/_getting_started.html.erb -->
<div class="card border-0">
  <div class="card-body p-0">
    <div class="progress mb-3">
      <%
        # Calculate progress based on completed tasks
        tasks_completed = 0
        tasks_completed += 1 if current_user.onboarding_completed?
        tasks_completed += 1 if current_user.tutorial_completed?
        tasks_completed += 1 if current_user.accounts.any?
        tasks_completed += 1 if current_user.transactions.any?
        tasks_completed += 1 if current_user.budgets.any?

        progress_percentage = (tasks_completed.to_f / 5 * 100).round
      %>
      <div class="progress-bar bg-success" role="progressbar" style="width: <%= progress_percentage %>%;"
           aria-valuenow="<%= progress_percentage %>" aria-valuemin="0" aria-valuemax="100">
        <%= progress_percentage %>%
      </div>
    </div>

    <div class="list-group mb-3">
      <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                  <%= current_user.onboarding_completed? ? 'list-group-item-success' : '' %>">
        <div>
          <div class="d-flex align-items-center">
            <div class="task-icon me-2 <%= current_user.onboarding_completed? ? 'bg-success' : 'bg-secondary' %>">
              <i class="bi <%= current_user.onboarding_completed? ? 'bi-check-lg' : 'bi-person' %>"></i>
            </div>
            <div>
              <h6 class="mb-0">Complete Your Profile</h6>
              <small class="text-muted">Add your personal and business information</small>
            </div>
          </div>
        </div>
        <% if current_user.onboarding_completed? %>
          <span class="badge bg-success rounded-pill">Done</span>
        <% else %>
          <%= link_to "Complete", onboarding_profile_path, class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>

      <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                  <%= current_user.tutorial_completed? ? 'list-group-item-success' : '' %>">
        <div>
          <div class="d-flex align-items-center">
            <div class="task-icon me-2 <%= current_user.tutorial_completed? ? 'bg-success' : 'bg-secondary' %>">
              <i class="bi <%= current_user.tutorial_completed? ? 'bi-check-lg' : 'bi-info-circle' %>"></i>
            </div>
            <div>
              <h6 class="mb-0">Complete the Tutorial</h6>
              <small class="text-muted">Take a quick tour of Cashly's features</small>
            </div>
          </div>
        </div>
        <% if current_user.tutorial_completed? %>
          <span class="badge bg-success rounded-pill">Done</span>
        <% else %>
          <button class="btn btn-sm btn-primary" id="startTutorial">Start</button>
        <% end %>
      </div>

      <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                  <%= current_user.accounts.any? ? 'list-group-item-success' : '' %>">
        <div>
          <div class="d-flex align-items-center">
            <div class="task-icon me-2 <%= current_user.accounts.any? ? 'bg-success' : 'bg-secondary' %>">
              <i class="bi <%= current_user.accounts.any? ? 'bi-check-lg' : 'bi-bank' %>"></i>
            </div>
            <div>
              <h6 class="mb-0">Connect an Account</h6>
              <small class="text-muted">Link your bank account or add one manually</small>
            </div>
          </div>
        </div>
        <% if current_user.accounts.any? %>
          <span class="badge bg-success rounded-pill">Done</span>
        <% else %>
          <%= link_to "Add", accounts_path, class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>

      <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                  <%= current_user.transactions.any? ? 'list-group-item-success' : '' %>">
        <div>
          <div class="d-flex align-items-center">
            <div class="task-icon me-2 <%= current_user.transactions.any? ? 'bg-success' : 'bg-secondary' %>">
              <i class="bi <%= current_user.transactions.any? ? 'bi-check-lg' : 'bi-receipt' %>"></i>
            </div>
            <div>
              <h6 class="mb-0">Record Transactions</h6>
              <small class="text-muted">Add financial transactions or import them</small>
            </div>
          </div>
        </div>
        <% if current_user.transactions.any? %>
          <span class="badge bg-success rounded-pill">Done</span>
        <% else %>
          <%= link_to "Add", new_transaction_path, class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>

      <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                  <%= current_user.budgets.any? ? 'list-group-item-success' : '' %>">
        <div>
          <div class="d-flex align-items-center">
            <div class="task-icon me-2 <%= current_user.budgets.any? ? 'bg-success' : 'bg-secondary' %>">
              <i class="bi <%= current_user.budgets.any? ? 'bi-check-lg' : 'bi-pie-chart' %>"></i>
            </div>
            <div>
              <h6 class="mb-0">Create a Budget</h6>
              <small class="text-muted">Set up your first budget category</small>
            </div>
          </div>
        </div>
        <% if current_user.budgets.any? %>
          <span class="badge bg-success rounded-pill">Done</span>
        <% else %>
          <%= link_to "Create", new_budget_path, class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>
    </div>

    <div id="hideGuideContainer" class="text-center mb-2">
      <a href="#" id="hideGettingStartedGuide" class="text-muted small">
        <i class="bi bi-eye-slash"></i> Don't show this again
      </a>
    </div>
  </div>
</div>

<script>
    document.addEventListener('turbo:load', initGettingStarted);
    document.addEventListener('DOMContentLoaded', initGettingStarted);

    function initGettingStarted() {
        const startTutorial = document.getElementById('startTutorial');
        const hideGettingStartedGuide = document.getElementById('hideGettingStartedGuide');

        if (startTutorial) {
            startTutorial.addEventListener('click', function() {
                // Show the tutorial overlay
                const tutorialOverlay = document.getElementById('tutorialOverlay');
                if (tutorialOverlay) {
                    tutorialOverlay.style.display = 'flex';
                } else {
                    // If the tutorial component isn't loaded, redirect to the dashboard
                    window.location.href = '/dashboard?tutorial=true';
                }
            });
        }

        if (hideGettingStartedGuide) {
            hideGettingStartedGuide.addEventListener('click', function(e) {
                e.preventDefault();

                // Hide the popup
                const onboardingPopup = document.getElementById('onboardingPopup');
                if (onboardingPopup) {
                    onboardingPopup.style.display = 'none';
                }

                // Remember that the user closed the guide via AJAX
                fetch('/dashboard/hide_getting_started', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    }
                }).catch(error => console.error('Error:', error));
            });
        }
    }
</script>