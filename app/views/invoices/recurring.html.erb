<!-- app/views/invoices/recurring.html.erb -->
<div class="container my-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1>Recurring Invoices</h1>
      <p class="text-muted">Manage your recurring invoice subscriptions</p>
    </div>

    <%= link_to invoices_path, class: "btn btn-outline-primary" do %>
      <i class="bi bi-arrow-left"></i> Back to Invoices
    <% end %>
  </div>

  <% if @invoices.any? %>
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead class="bg-light">
            <tr>
              <th>Invoice</th>
              <th>Client</th>
              <th>Amount</th>
              <th>Frequency</th>
              <th>Next Payment</th>
              <th>Status</th>
              <th class="text-end">Actions</th>
            </tr>
            </thead>
            <tbody>
            <% @invoices.each do |invoice| %>
              <tr>
                <td>
                  <a href="<%= invoice_path(invoice) %>">
                    <%= invoice.generate_invoice_number %>
                  </a>
                </td>
                <td>
                  <%= invoice.client_name %>
                  <div class="text-muted small"><%= invoice.client_email %></div>
                </td>
                <td class="text-nowrap">
                  <%= invoice.formatted_currency %>
                </td>
                <td>
                    <span class="badge bg-info">
                      <%= invoice.recurring_period.to_i %> <%= invoice.recurring_interval&.titleize %>
                    </span>
                </td>
                <td class="text-nowrap">
                  <% if invoice.next_payment_date %>
                    <%= invoice.next_payment_date.strftime('%b %d, %Y') %>

                    <% days_until = (invoice.next_payment_date - Date.today).to_i %>
                    <% if days_until <= 7 %>
                        <span class="badge bg-warning ms-1">
                          <%= days_until %> days
                        </span>
                    <% end %>
                  <% else %>
                    <span class="text-muted">Not scheduled</span>
                  <% end %>
                </td>
                <td>
                  <% case invoice.status %>
                  <% when 'pending' %>
                    <span class="badge bg-warning">Active</span>
                  <% when 'paid' %>
                    <span class="badge bg-success">Active</span>
                  <% else %>
                    <span class="badge bg-secondary"><%= invoice.status.titleize %></span>
                  <% end %>
                </td>
                <td class="text-end">
                  <div class="btn-group">
                    <%= link_to invoice_path(invoice), class: "btn btn-sm btn-outline-primary" do %>
                      <i class="bi bi-eye"></i>
                    <% end %>

                    <%= link_to cancel_recurring_invoice_path(invoice), method: :post,
                                data: { confirm: "Are you sure you want to cancel this recurring invoice?" },
                                class: "btn btn-sm btn-outline-danger" do %>
                      <i class="bi bi-x-circle"></i> Cancel
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-center">
      <%= paginate @invoices if @invoices.respond_to?(:total_pages) %>
    </div>

  <% else %>
    <div class="card border-0 shadow-sm">
      <div class="card-body py-5">
        <div class="text-center">
          <i class="bi bi-arrow-repeat text-muted" style="font-size: 48px;"></i>
          <h4 class="mt-3">No Recurring Invoices Yet</h4>
          <p class="text-muted">You haven't set up any recurring invoices yet.</p>

          <p class="mt-4">
            <%= link_to invoices_path, class: "btn btn-primary" do %>
              <i class="bi bi-plus-circle"></i> Create an Invoice
            <% end %>
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <div class="card border-0 shadow-sm mt-4">
    <div class="card-header bg-white">
      <h5 class="mb-0">About Recurring Invoices</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="d-flex">
            <div class="me-3">
              <i class="bi bi-arrow-repeat text-primary" style="font-size: 24px;"></i>
            </div>
            <div>
              <h6>How It Works</h6>
              <p class="text-muted small">Recurring invoices automatically bill your clients on a schedule you define.</p>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3 mb-md-0">
          <div class="d-flex">
            <div class="me-3">
              <i class="bi bi-credit-card text-primary" style="font-size: 24px;"></i>
            </div>
            <div>
              <h6>Payment Processing</h6>
              <p class="text-muted small">Stripe automatically processes payments on the scheduled date.</p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="d-flex">
            <div class="me-3">
              <i class="bi bi-bell text-primary" style="font-size: 24px;"></i>
            </div>
            <div>
              <h6>Notifications</h6>
              <p class="text-muted small">You and your client receive email notifications for each payment.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>